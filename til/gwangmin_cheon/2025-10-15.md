# 📆 2025-10-15(수) TIL

# ⚡ WebSocket(웹 소켓)
## 🤔 WebSocket이란?
- 서버와 클라이언트 간의 메시지 교환을 위한 **통신 규약(프로토콜)**

## 🕸️ WebSocket 기본 구조
### WebSocket 핸드셰이크
- 처음 연결할 때 클라이언트는 HTTP 요청을 보내며 이 요청에 서버는 WebSocket 프로토콜로 업그레이드 응답을 보냄
### 지속적인 연결
- 한 번 연결이 이루어지면 클라이언트와 서버 간의 연결은 계속 유지되며, 데이터를 양방향으로 주고받을 수 있음
### 데이터 전송
- WebSocket은 텍스트, 바이너리 빅데이터 등 다양한 형식의 메시지를 전송할 수 있음음

## 📌 WebSocket 특징
### 양방향 통신(Full-Duplex)
- 데이터 송수신을 동시에 처리할 수 있는 방법
- 통상적인 HTTP 통신은 클라이언트가 요청을 보내는 경우에만 Server가 응답을 하는 단방향 통신이지만, WebSocket은 양방향 통신이 가능하다.

### 실시간 네트워킹(Real Time Networking)
- 웹 환경에서 연속된 데이터를 빠르게 노출하는 것(채팅, 주식 등)

### 지속적인 연결
- HTTP 요청처럼 매번 연결을 만들고 끊을 필요 없이, 하나의 연결로 여러 번 데이터를 주고받을 수 있음

### 낮은 대기시간
- 연결이 지속되므로, 데이터가 즉시 전송되고 응답이 빨라 실시간성을 요하는 애플리케이션에 적합

## 💼 WebSocket 동작 과정
![WebSock_working](./websocket_working.jpg)
- 빨간색 박스: **Opening Handshake**
- 노란색 박스: **Data transfer**
- 보라색 박스: **Closing Handshake**

## 🫱🏻‍🫲🏻 WebSocketHandshake
> WebSocket 프로토콜은 HTTP 기반의 핸드셰이크를 사용하여 초기 연결을 설정
- 클라이언트는 웹 서버에 HTTP 요청을 보내고, Upgrade 헤더를 포함해서 WebSocket 연결로 전환
- 서버는 클라이언트의 요청을 확인하고, 101 Switching Protocols 응답을 반환해서 WebSocket 연결을 수락
- 클라이언트와 서버는 WebSocket 프로토콜을 사용하여 양방향 통신을 시작

### 요청(Request) 헤더
```http
GET /chat HTTP/1.1
Host: localhost:8080
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: X3JJHMbDL1EzLkh9GBhXdw==
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
Origin: http://localhost:9000
```
**GET/chat HTTP/1.1**
- WebSocket의 통신 요청에서 HTTP 버전은 1.1 이상이어야하고 GET 메서드를 사용해야 한다.

**Upgrade**
- 프로토콜을 전환하기 위해 사용하는 헤더
- WebSocket 요청 시에는 반스에 websocket이라는 값을 가지며, 이 값이 없거나 다른 값이면 cross-protocol attack이라고 간주하여 웹 소켓 접속을 중지시킨다.

**Connection**
- 현재 전송이 완료된 후 네트워크 접속을 유지할 것인가에 대한 정보
- 웹 소켓 요청 시에는 반드시 Upgrade라는 값을 가진다.
- Upgrade와 마찬가지로 이 값이 없거나 다른 값이면 WebSocket 접속을 중지시킨다.

**Sec-WebSocket-Key**
- 유효한 요청인지 확인하기 위해 사용하는 키 값

**Sec-WebSocket-Protocol**
- 사용하고자 하는 하나 이상의 WebSocket Protocol 지정
- 필요한 경우에만 사용

**Sec-WebSocket-Version**
- 클라이언트가 사용하고자 하는 WebSocket Protocal Version

**Origin**
- CORS 정책으로 만들어진 헤더
- Cross-Site WebSocket Hijacking과 같은 공격을 피하기 위함

### 응답(Response) 헤더
```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMIYUkAGmm50PpG2HaGWK=
Sec-WebSocket-Protocol: chat
```
**HTTP/1.1 101 Switching Protocols**
- 101은 HTTP에서 WS로 프로토콜 전환이 승인되었다는 응답코드

**Sec-WebSocket-Accept**
- 요청 헤더의 Sec-WebSocket-Key에 유니크 아이디를 더해서 SHA-1로 해싱한 후 base64로 인코딩한 결과
- WebSocket 연결이 개시되었음을 알림

## ↔️ Data Transfer
> Opening HandShake에서 승인이 나면, WebSocket Protocol로 노란색 박스 부분인 Data Transfer이 진행되며 데이터는 **메시지**라는 단위로 전달

![websocket_working](./websocket_working.jpg)

**메시지**
- 여러 프레임(frame)이 모여서 구성되는 하나의 논리적인 메시지 단위

**프레임**
- 통신에서 가장 작은 단위의 데이터
    (패킷은 전체 네트워크 통신 과정에서 가장 작은 단위의 데이터)
- 프레임은 데이터 링크계층(이더넷)에서 주고 받는 가장 작은 단위를 의미(작은 헤더 + payload로 구성)

## ⚡ Socket.io
- WebSocket은 HTML5의 기술이기 때문에 오래된 버전의 웹 브라우저는 WebSocket을 지원하지 않음
- 이를 해결하기 위해 나온 기술 중 하나가 **Socket.io**
- 양방향 통신을 하기 위해 WebSocket 기술을 활용하는 Node.js의 라이브러리
- WebSocket, Polling, Streaming 등 다양한 방법을 하나의 API로 추상화한 것
- JavaScript를 이용하여 브라우저 종류에 상관없이 실시간 WEB을 구현할 수 있음

# 💭 배운 점
- WebRTC 프로젝트를 하며 WebSocket에 대해서도 이야기가 나왔었는데 이번 기회를 통해 알게 되었습니다.
- **서버 중심 메시지 파이프**는 WebSocket, **P2P 미디어/데이터 전송 스택***은 WebRTC이라는 것을 알게 되었습니다.
- 결론적으로 화상 미팅 또는 화상 회의에서 WebRTC와 WebSocket을 적절히 활용하면 사용자가 불편을 겪을 수 있는 상황(영상 사용 불가 시 WebSocket을 활용한 채팅 대처)을 상호보완하는 서비스를 기획하는데 많은 도움이 될 것 같습니다.